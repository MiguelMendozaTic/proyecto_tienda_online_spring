<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlazaChina - Confirmar Pago</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(to right, #f59e42, #ef4444);
        }
        .gradient-logo {
            background: linear-gradient(to right, #ef4444, #f59e42);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .card-shadow {
            box-shadow: 0 4px 16px 0 rgba(31,41,55,0.07), 0 1.5px 4px 0 rgba(245,158,66,0.08);
        }
    </style>
</head>
<body class="bg-[#f7f8fa] flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center">
        <div class="text-2xl font-bold gradient-logo flex items-center gap-2">
            <i class="bi bi-shop"></i>
            <a href="/bienvenida" class="gradient-logo">PlazaChina</a>
        </div>
        <div class="flex items-center space-x-4">
            <a href="/bienvenida" class="text-gray-700 hover:text-orange-600 font-medium"><i class="bi bi-house-door"></i> Inicio</a>
            <a href="/nosotros" class="text-gray-700 hover:text-orange-600 font-medium"><i class="bi bi-people"></i> Nosotros</a>
            <a href="/productos" class="text-gray-700 hover:text-orange-600 font-medium"><i class="bi bi-box"></i> Productos</a>
            <a href="/logout" class="text-red-600 hover:text-red-800 font-medium"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
            <a href="/carrito" class="relative">
                <i class="bi bi-cart text-xl text-gray-700 hover:text-orange-600"></i>
                <span th:if="${carritoCount > 0}" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-semibold rounded-full h-5 w-5 flex items-center justify-center" th:text="${carritoCount}">0</span>
            </a>
        </div>
    </nav>

    <main class="flex-grow flex items-center justify-center p-4 md:p-8">
        <div class="bg-white p-8 md:p-12 rounded-2xl card-shadow text-center max-w-md w-full">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-8">Confirmar Pago</h2>

            <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <span class="block sm:inline" th:text="${error}"></span>
            </div>

            <div class="space-y-4 mb-8 text-left">
                <p class="text-lg text-gray-700" th:if="${numeroOrden}"><strong>Número de Orden:</strong> <span class="font-medium text-orange-600" th:text="${numeroOrden}"></span></p>
                <p class="text-lg text-gray-700"><strong>Monto Total:</strong> <span class="text-orange-700 font-bold" th:text="'S/ ' + ${#numbers.formatDecimal(totalPagar, 1, 'COMMA', 2, 'POINT')}">S/ 0.00</span></p>
                <p class="text-lg text-gray-700"><strong>Método de Pago:</strong> <span class="font-medium" th:text="${metodoPago}"></span></p>
                <p class="text-lg text-gray-700"><strong>Número de Boleta:</strong> <span class="font-medium" th:text="${numeroBoleta}"></span></p>
            </div>

            <!-- Pasarela de pago mejorada -->
            <div class="mb-8">
                <!-- Mensaje de error si la pasarela falló -->
                <div th:if="${resultadoPasarela != null and !resultadoPasarela.exitoso}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <span class="block sm:inline" th:text="${resultadoPasarela.mensaje}"></span>
                </div>

                <!-- Yape -->
                <div th:if="${metodoPago == 'yape' and resultadoPasarela != null and resultadoPasarela.exitoso}" class="flex flex-col items-center gap-3">
                    <div class="bg-purple-50 p-6 rounded-xl border-2 border-purple-200">
                        <div class="flex items-center justify-center mb-4">
                            <img src="https://images.seeklogo.com/logo-png/38/1/yape-logo-png_seeklogo-381640.png" alt="Yape Logo" class="h-8 object-contain">
                        </div>
                        <div class="qr-container bg-white p-4 rounded-lg border-2 border-purple-300 mb-4">
                            <img src="/images/yapee1.jpg" alt="QR Yape" class="w-48 h-48 mx-auto">
                        </div>
                        <p class="text-gray-700 text-center mb-3">Escanea el código QR con tu app <span class="font-bold text-purple-600">Yape</span></p>
                        <div class="bg-purple-100 text-purple-800 px-4 py-3 rounded-lg font-bold text-center">
                            <div class="text-sm text-purple-600 mb-1">Número de teléfono:</div>
                            <div class="text-lg" th:text="${resultadoPasarela.numeroTelefono}">999 999 999</div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="text-sm text-gray-600 mb-1">Referencia:</div>
                            <div class="font-mono text-sm bg-gray-100 px-2 py-1 rounded" th:text="${resultadoPasarela.referencia}"></div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="text-sm text-gray-600 mb-1">Monto:</div>
                            <div class="font-bold text-lg text-purple-700" th:text="'S/ ' + ${#numbers.formatDecimal(resultadoPasarela.monto, 1, 'COMMA', 2, 'POINT')}"></div>
                        </div>
                    </div>
                </div>

                <!-- Plin -->
                <div th:if="${metodoPago == 'plin' and resultadoPasarela != null and resultadoPasarela.exitoso}" class="flex flex-col items-center gap-3">
                    <div class="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
                        <div class="flex items-center justify-center mb-4">
                            <img src="https://tse4.mm.bing.net/th/id/OIP.Wpbss6VhwGRy_X2G6GstRAHaHa?r=0&w=600&h=600&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Plin Logo" class="h-8 object-contain">
                        </div>
                        <div class="qr-container bg-white p-4 rounded-lg border-2 border-blue-300 mb-4">
                            <img th:src="${resultadoPasarela.qrCode}" alt="QR Plin" class="w-48 h-48 mx-auto">
                        </div>
                        <p class="text-gray-700 text-center mb-3">Escanea el código QR con tu app <span class="font-bold text-blue-600">Plin</span></p>
                        <div class="bg-blue-100 text-blue-800 px-4 py-3 rounded-lg font-bold text-center">
                            <div class="text-sm text-blue-600 mb-1">Número de teléfono:</div>
                            <div class="text-lg" th:text="${resultadoPasarela.numeroTelefono}">999 999 999</div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="text-sm text-gray-600 mb-1">Referencia:</div>
                            <div class="font-mono text-sm bg-gray-100 px-2 py-1 rounded" th:text="${resultadoPasarela.referencia}"></div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="text-sm text-gray-600 mb-1">Monto:</div>
                            <div class="font-bold text-lg text-blue-700" th:text="'S/ ' + ${#numbers.formatDecimal(resultadoPasarela.monto, 1, 'COMMA', 2, 'POINT')}"></div>
                        </div>
                    </div>
                </div>

                <!-- PayPal -->
                <div th:if="${metodoPago == 'paypal' and resultadoPasarela != null and resultadoPasarela.exitoso}" class="flex flex-col items-center gap-3">
                    <div class="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
                        <div class="flex items-center justify-center mb-4">
                            <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal Logo" class="h-8 object-contain">
                        </div>
                        <p class="text-gray-700 text-center mb-4">Serás redirigido a <span class="font-bold text-blue-700">PayPal</span> para completar tu pago de forma segura.</p>
                        <div class="bg-blue-100 text-blue-800 px-4 py-3 rounded-lg font-bold text-center mb-4">
                            <div class="text-sm text-blue-600 mb-1">Monto a pagar:</div>
                            <div class="text-lg" th:text="'S/ ' + ${#numbers.formatDecimal(resultadoPasarela.monto, 1, 'COMMA', 2, 'POINT')}"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-600 mb-1">Referencia:</div>
                            <div class="font-mono text-sm bg-gray-100 px-2 py-1 rounded" th:text="${resultadoPasarela.referencia}"></div>
                        </div>
                        <a th:href="${resultadoPasarela.paypalUrl}" target="_blank" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl w-full text-center transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="bi bi-box-arrow-up-right mr-2"></i> Ir a PayPal
                        </a>
                    </div>
                </div>
            </div>

            <form th:action="@{/pago/confirmar}" method="post">
                <input type="hidden" name="numeroOrden" th:value="${numeroOrden}" />
                <input type="hidden" name="metodoPago" th:value="${metodoPago}" />
                <input type="hidden" name="totalPagar" th:value="${totalPagar}" />
                <input type="hidden" name="numeroBoleta" th:value="${numeroBoleta}" />
                <button type="submit" class="gradient-bg text-white font-bold py-3 px-6 rounded-xl w-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="bi bi-check-circle-fill"></i> Confirmar y Realizar Pago
                </button>
            </form>

            <a href="/carrito" class="inline-block mt-6 text-orange-600 hover:underline font-semibold flex items-center justify-center gap-2">
                <i class="bi bi-arrow-left"></i> Volver al Carrito
            </a>
        </div>
    </main>

    <!-- Modal de verificación de pago -->
    <div id="verificacionModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-md w-full mx-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Verificando pago...</h3>
            <p class="text-gray-600 text-sm">Por favor espera mientras verificamos tu pago</p>
        </div>
    </div>

    <!-- Script externo para la funcionalidad de pago -->
    <script src="/js/pago.js"></script>
    <script th:inline="javascript">
        // Inicializar variables del servidor cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            const metodoPago = /*[[${metodoPago}]]*/ '';
            const numeroBoleta = /*[[${numeroBoleta}]]*/ '';
            const totalPagar = /*[[${totalPagar}]]*/ 0;
            
            // Inicializar variables en el archivo JS externo
            inicializarVariables(metodoPago, numeroBoleta, totalPagar);
            
            // Iniciar la verificación automática
            iniciarVerificacion();
        });
    </script>

    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p>&copy; 2025 PlazaChina. Todos los derechos reservados.</p>
    </footer>
</body>
</html>
