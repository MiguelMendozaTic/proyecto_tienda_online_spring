<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topito - Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .chart-container {
            width: 100%;
            height: 300px; /* Altura fija para los gráficos */
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .chart-svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <nav class="bg-gray-800 shadow-md p-4 flex justify-between items-center text-white">
        <div class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
            PlazaChina Admin
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-gray-300">Bienvenido, <span sec:authentication="name" th:text="${nombreAdmin}">Admin</span></span>
            <a href="/admin/productos" class="text-gray-300 hover:text-white font-medium">Gestionar Productos</a>
            <a href="/admin/descuentos" class="text-gray-300 hover:text-white font-medium">Descuentos</a>
            <a href="/admin/usuarios" class="text-gray-300 hover:text-white font-medium">Visualizar Usuarios</a>
            <a href="/admin/ventas" class="text-gray-300 hover:text-white font-medium">Ventas</a>
            <a href="/logout" class="text-red-400 hover:text-red-600 font-medium">Cerrar Sesión</a>
        </div>
    </nav>

    <header class="bg-gradient-to-r from-blue-500 to-purple-600 py-12 text-center text-white">
        <h1 class="text-4xl font-extrabold animate-pulse">
            <i class="fas fa-chart-line mr-2"></i> Panel de Administración
        </h1>
        <p class="text-lg mt-2">Estadísticas y Gestión de la Tienda</p>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8">
        <section class="mb-10">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6">Resumen de Ventas y Productos</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Ventas Diarias (Últimos 7 Días)</h3>
                    <svg id="dailySalesChart" class="chart-svg"></svg>
                </div>

                <div class="chart-container">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Ventas Mensuales (Año Actual)</h3>
                    <svg id="monthlySalesChart" class="chart-svg"></svg>
                </div>

                <div class="chart-container lg:col-span-2">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Productos Más Vendidos (Top 5)</h3>
                    <svg id="mostSoldProductsChart" class="chart-svg"></svg>
                </div>
            </div>
        </section>

        <section class="mb-10">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6">Últimas Ventas</h2>
            <div class="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pago</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Método</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Boleta</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="pago : ${ultimasVentas}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${pago.id}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${pago.usuario.nombre + ' ' + pago.usuario.apellido}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="'S/ ' + ${#numbers.formatDecimal(pago.montoPagado, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${pago.metodoPago}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${#temporals.format(pago.fechaVenta, 'dd/MM/yyyy HH:mm')}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${pago.numeroBoleta}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p>&copy; 2025 PlazaChina. Todos los derechos reservados.</p>
    </footer>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Datos para gráficos - Ahora el controlador envía JSON válido con LocalDate convertidas a String
        const dailySalesData = /*[[${salesByDay}]]*/ {};
        const monthlySalesData = /*[[${salesByMonth}]]*/ {};
        const mostSoldProductsData = /*[[${mostSoldProducts}]]*/ [];

        // Función para dibujar el gráfico de ventas diarias (Barras)
        function drawDailySalesChart() {
            const data = dailySalesData && Object.keys(dailySalesData).length > 0 ? Object.entries(dailySalesData).map(([date, amount]) => ({
                date: new Date(date),
                amount: Number(amount) || 0
            })) : [];

            // Si no hay datos, mostrar mensaje de referencia
            if (true) {
                const svg = d3.select("#dailySalesChart");
                const width = document.getElementById('dailySalesChart').clientWidth;
                const height = document.getElementById('dailySalesChart').clientHeight;
                
                svg.attr("viewBox", `0 0 ${width} ${height}`);
                svg.append("rect")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("fill", "#f9fafb");
                
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("dy", ".3em")
                    .style("font-size", "16px")
                    .style("fill", "#666")
                    .text("No hay datos de ventas diarias");
                    
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2 + 30)
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("fill", "#999")
                    .text("Los gráficos aparecerán cuando haya ventas");
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 50 };
            const width = document.getElementById('dailySalesChart').clientWidth - margin.left - margin.right;
            const height = document.getElementById('dailySalesChart').clientHeight - margin.top - margin.bottom;

            const svg = d3.select("#dailySalesChart")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.amount) * 1.1])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => "S/ " + d3.format(",.0f")(d)));

            svg.selectAll("mybar")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", d => x(d.date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })))
                .attr("y", d => y(d.amount))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.amount))
                .attr("fill", "#6a11cb");

            // Añadir etiquetas de valor en las barras
            svg.selectAll(".bar-label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })) + x.bandwidth() / 2)
                .attr("y", d => y(d.amount) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "#333")
                .text(d => "S/ " + d3.format(",.0f")(d.amount));
        }

        // Función para dibujar el gráfico de ventas mensuales (Barras)
        function drawMonthlySalesChart() {
            const data = monthlySalesData && Object.keys(monthlySalesData).length > 0 ? Object.entries(monthlySalesData).map(([month, amount]) => ({
                month: parseInt(month),
                amount: Number(amount) || 0
            })) : [];

            // Ordenar por mes
            data.sort((a, b) => a.month - b.month);

            // Si no hay datos, mostrar mensaje de referencia
            if (data.length === 0 || data.every(d => d.amount === 0)) {
                const container = d3.select("#monthlySalesChart");
                container.attr("viewBox", "0 0 400 300");
                
                // Mostrar imagen de ejemplo
                container.append("image")
                    .attr("href", "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3Ctext x='200' y='150' text-anchor='middle' font-size='16' fill='%23666'%3ENo hay datos de ventas mensuales%3C/text%3E%3C/svg%3E")
                    .attr("width", 400)
                    .attr("height", 300);
                return;
            }

            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

            const margin = { top: 20, right: 30, bottom: 40, left: 50 };
            const width = document.getElementById('monthlySalesChart').clientWidth - margin.left - margin.right;
            const height = document.getElementById('monthlySalesChart').clientHeight - margin.top - margin.bottom;

            const svg = d3.select("#monthlySalesChart")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => monthNames[d.month - 1]))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.amount) * 1.1])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => "S/ " + d3.format(",.0f")(d)));

            svg.selectAll("mybar")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", d => x(monthNames[d.month - 1]))
                .attr("y", d => y(d.amount))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.amount))
                .attr("fill", "#2575fc");

            // Añadir etiquetas de valor en las barras
            svg.selectAll(".bar-label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(monthNames[d.month - 1]) + x.bandwidth() / 2)
                .attr("y", d => y(d.amount) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "#333")
                .text(d => "S/ " + d3.format(",.0f")(d.amount));
        }

        // Función para dibujar el gráfico de productos más vendidos (Pie Chart)
        function drawMostSoldProductsChart() {
            const data = Array.isArray(mostSoldProductsData) && mostSoldProductsData.length > 0 ? mostSoldProductsData : [];

            if (!data || data.length === 0) {
                const width = document.getElementById('mostSoldProductsChart').clientWidth;
                const height = document.getElementById('mostSoldProductsChart').clientHeight;
                
                const svg = d3.select("#mostSoldProductsChart")
                    .attr("viewBox", `0 0 ${width} ${height}`);
                
                svg.append("rect")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("fill", "#f0f0f0");
                
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("dy", ".3em")
                    .style("font-size", "16px")
                    .style("fill", "#666")
                    .text("No hay datos de productos más vendidos");
                return;
            }

            const width = document.getElementById('mostSoldProductsChart').clientWidth;
            const height = document.getElementById('mostSoldProductsChart').clientHeight;
            const radius = Math.min(width, height) / 2 - 20;

            const svg = d3.select("#mostSoldProductsChart")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const pie = d3.pie()
                .sort(null)
                .value(d => d.cantidadVendida);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.nombreProducto))
                .attr("stroke", "white")
                .style("stroke-width", "2px");

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "white")
                .text(d => d.data.nombreProducto + " (" + d.data.cantidadVendida + ")");

            // Leyenda
            const legend = svg.selectAll(".legend")
                .data(color.domain())
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${radius + 20}, ${i * 20 - radius + 20})`); // Ajusta la posición

            legend.append("rect")
                .attr("width", 18)
                .attr("height", 18)
                .attr("fill", color);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "start")
                .style("font-size", "12px")
                .text(d => d);
        }


        // Dibujar todos los gráficos al cargar la página
        window.onload = function() {
            drawDailySalesChart();
            drawMonthlySalesChart();
            drawMostSoldProductsChart();
        };

        // Redibujar gráficos si la ventana cambia de tamaño (responsivo)
        window.addEventListener('resize', () => {
            d3.select("#dailySalesChart").selectAll("*").remove();
            d3.select("#monthlySalesChart").selectAll("*").remove();
            d3.select("#mostSoldProductsChart").selectAll("*").remove();
            drawDailySalesChart();
            drawMonthlySalesChart();
            drawMostSoldProductsChart();
        });
        /*]]>*/
    </script>
</body>
</html>